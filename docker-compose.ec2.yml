# EC2 환경용 docker-compose.yml
# 사용법: docker-compose -f docker-compose.ec2.yml up -d

version: '3.8'

services:
  workfolio-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: workfolio-server:latest
    container_name: workfolio-server
    ports:
      - "8080:8080"
    env_file:
      - docker-compose.env
    environment:
      # JVM 메모리 최적화 (t3.micro 1GB 메모리용)
      - JAVA_OPTIONS=-Xmx512m -Xms256m -Djava.security.egd=file:/dev/./urandom
      # Spring Boot 프로파일
      - SPRING_PROFILES_ACTIVE=prod
    restart: unless-stopped
    mem_limit: 768m
    mem_reservation: 512m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - workfolio-network
    # 외부 DB/Redis 사용 시 depends_on 제거
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # 외부 데이터베이스 사용 시 아래 서비스들은 주석 처리
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    env_file:
      - ./docker-compose.env
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "123456789a"
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d
    command:
      - postgres
      - -c
      - max_connections=50
      - -c
      - shared_buffers=128MB
      - -c
      - effective_cache_size=512MB
      - -c
      - maintenance_work_mem=32MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=8MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - work_mem=2MB
      - -c
      - min_wal_size=512MB
      - -c
      - max_wal_size=2GB
    networks:
      - workfolio-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    mem_limit: 256m
    mem_reservation: 128m

  redis:
    image: redis:8.2.0-alpine
    container_name: redis
    env_file:
      - docker-compose.env
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru --appendonly yes --save 900 1 --save 300 10 --save 60 10000
    networks:
      - workfolio-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    mem_limit: 128m
    mem_reservation: 64m

volumes:
  postgres-data:
  redis-data:

networks:
  workfolio-network:
    driver: bridge

