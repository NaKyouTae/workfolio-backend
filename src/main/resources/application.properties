spring.application.name=workfolio-server
spring.profiles.active=local
server.port=8080

spring.config.import=auth.properties,jwt.properties

# DataSource - Supabase PostgreSQL (Shared Pooler)
# Shared Pooler는 Session Pooler와 Transaction Pooler의 하이브리드
# Pool Size: 40 (Supabase 설정)
# Max Client Connections: 200 (고정값)
spring.datasource.username=postgres.jxbmvvqjilxblzrojkek
spring.datasource.password=${SUPABASE_DB_PASSWORD}
spring.datasource.hikari.driver-class-name=org.postgresql.Driver
# ⚠️ Connection Leak 문제 해결: Transaction Pooler 모드 사용 (port 5432)
# Transaction Pooler는 Connection이 트랜잭션 종료 시 즉시 반환되어 Connection leak을 방지합니다.
# Session Pooler (port 6543)는 세션이 종료될 때까지 Connection이 유지되어 Connection leak 위험이 높습니다.
# 
# 주의: Transaction Pooler는 Prepared Statement 사용에 제한이 있지만, Connection 반환이 더 빠릅니다.
# prepareThreshold=0: Prepared Statement 비활성화 (Transaction Pooler 호환)
spring.datasource.hikari.jdbc-url=jdbc:postgresql://aws-1-ap-northeast-2.pooler.supabase.com:5432/postgres?prepareThreshold=0&preparedStatementCacheQueries=0

# HikariCP 설정 (Shared Pooler용)
# Connection 할당 계산:
# - Supabase Pool Size: 40
# - Supabase 내부 서비스 (PostgREST, Supavisor, 모니터링 등): 약 12개
# - 애플리케이션 사용 가능: 40 - 12 = 28개
# - 안전 마진 (75% 사용): 28 × 0.75 = 약 21개
# - 여러 인스턴스 고려: 인스턴스당 20-25개 권장
# 
# 현재 설정: maximum-pool-size=20 (인스턴스당)
# - 단일 인스턴스: 20개 사용 (안전)
# - 2개 인스턴스: 40개 사용 (Pool Size 초과 위험)
# - 권장: 인스턴스당 15-20개, 또는 Pool Size를 50-60으로 증가
# auto-commit은 false로 설정 (Hibernate가 트랜잭션 관리)
spring.datasource.hikari.auto-commit=false
# ⚠️ Connection Leak 근본 해결: minimum-idle을 최소값으로 설정
# Supabase Transaction Pooler를 사용하므로, 최소 Connection 수를 낮춰서
# 불필요한 Connection 생성을 방지
# ⚠️ Connection 제거 비활성화: 10개 Connection을 고정으로 유지
# 
# 전략: Connection 제거를 비활성화하여 항상 10개를 유지
# - minimum-idle=10: maximum-pool-size와 동일하게 설정하여 항상 10개 유지
# - idle-timeout=0: Connection 제거 비활성화 (0 = 비활성화)
# - max-lifetime=24시간: Connection 교체를 최소화 (오래된 Connection도 유지)
# 
# 장점:
# - Connection이 제거되지 않아 새로 생성하지 않아도 됨
# - HikariCP와 PostgreSQL Connection 수가 일치하여 누적 문제 해결
# - Connection 재사용이 극대화됨
# 
# 단점:
# - 오래된 Connection이 문제가 될 수 있음 (하지만 keepalive로 감지)
# - 리소스 사용량이 고정됨 (하지만 10개는 적절한 수준)
spring.datasource.hikari.minimum-idle=10  # maximum-pool-size와 동일하게 설정하여 항상 10개 유지
spring.datasource.hikari.maximum-pool-size=10  # 최대 10개 Connection
spring.datasource.hikari.connection-timeout=30000
# ⚠️ Connection 제거 비활성화: idle-timeout=0으로 설정
# 0으로 설정하면 Connection이 제거되지 않고 계속 유지됨
spring.datasource.hikari.idle-timeout=0  # 0 = 비활성화 (Connection 제거 안 함)
# ⚠️ Connection 교체 최소화: max-lifetime을 24시간으로 설정
# 오래된 Connection도 유지하여 교체를 최소화
# keepalive-time으로 죽은 Connection은 감지하므로 안전함
spring.datasource.hikari.max-lifetime=86400000  # 24시간 (Connection 교체 최소화)
# ⚠️ Connection Leak 근본 해결: keepalive-time 추가
# Connection이 유효한지 주기적으로 확인하여 죽은 Connection을 제거
# 30초마다 keepalive 쿼리 실행
spring.datasource.hikari.keepalive-time=30000  # 30초
# Connection leak 감지 시간 (30초) - Connection이 30초 이상 점유되면 경고
spring.datasource.hikari.leak-detection-threshold=30000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.connection-test-query=SELECT 1
# ⚠️ Connection Leak 근본 해결: Connection 초기화 시 PostgreSQL 설정 자동 적용
# 각 Connection이 생성될 때마다 idle_in_transaction_session_timeout 설정 적용
# 이렇게 하면 Supabase에서 세션 레벨 설정이 각 Connection에 적용됨
spring.datasource.hikari.connection-init-sql=SET idle_in_transaction_session_timeout = '5min'
spring.datasource.hikari.data-source-properties.prepareThreshold=0
spring.datasource.hikari.data-source-properties.cachePrepStmts=false

# JPA
spring.jpa.open-in-view=false
spring.jpa.hibernate.ddl-auto=none
spring.jpa.generate-ddl=false

# 전역 트랜잭션 타임아웃 설정 (초 단위)
# 모든 @Transactional 메서드에 기본적으로 적용됨
# 개별 메서드에서 @Transactional(timeout = X)로 지정하면 그 값이 우선 적용됨
spring.transaction.default-timeout=30
spring.jpa.properties.hibernate.jdbc.batch_size=100
spring.jpa.properties.hibernate.default_batch_fetch_size=1000
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_deletes=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.jdbc.batch_versioned_data=true
spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true
spring.jpa.properties.hibernate.connection.provider_disables_autocommit=true
spring.jpa.properties.hibernate.cache.use_second_level_cache=false
spring.jpa.properties.hibernate.cache.use_query_cache=false
spring.jpa.properties.hibernate.jdbc.time_zone=Asia/Seoul
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

spring.sql.init.mode=always
spring.sql.init.encoding=UTF-8
#spring.sql.init.data-locations=classpath*:data.sql

spring.batch.jdbc.initialize-schema=always
spring.batch.job.enabled=true

# Redis
spring.data.redis.database=0
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.password=
spring.data.redis.timeout=60000

logging.level.com.example.todolist=debug
logging.level.org.hibernate.SQL=info
logging.level.org.hibernate.type=off
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.web=DEBUG
logging.level.org.springframework.http=DEBUG

logging.level.org.springframework.web.client.RestTemplate=DEBUG

logging.level.org.springframework.security.oauth2=DEBUG

org.springframework.security= TRACE
org.springframework.web= TRACE

# HikariCP Connection Pool 모니터링
# Connection 생성/반환 추적을 위한 상세 로깅
logging.level.com.zaxxer.hikari=DEBUG
logging.level.com.zaxxer.hikari.HikariConfig=INFO
logging.level.com.zaxxer.hikari.pool.HikariPool=DEBUG
logging.level.com.zaxxer.hikari.pool.HikariPool.addConnection=DEBUG
logging.level.com.zaxxer.hikari.pool.HikariPool.getConnection=DEBUG
logging.level.com.zaxxer.hikari.pool.PoolBase=DEBUG

# 트랜잭션 모니터링
logging.level.org.springframework.transaction=DEBUG
logging.level.org.springframework.orm.jpa=DEBUG
logging.level.org.hibernate.engine.transaction=DEBUG

server.servlet.encoding.charset=UTF-8
server.servlet.encoding.enabled=true
server.servlet.encoding.force=true

# Liquibase (일시적으로 비활성화 - 연결 테스트용)
spring.liquibase.enabled=true

# Kakao API
kakao.api.base-url=https://kapi.kakao.com
kakao.api.admin-key=b38da3a5432ea55e0b72decdf29d766e

# Supabase Configuration
supabase.url=https://jxbmvvqjilxblzrojkek.supabase.co
supabase.storage-url=https://jxbmvvqjilxblzrojkek.storage.supabase.co/storage/v1/s3
supabase.region=ap-northeast-2
supabase.access-key=${SUPABASE_ACCESS_KEY}
supabase.secret-key=${SUPABASE_SECRET_KEY}
